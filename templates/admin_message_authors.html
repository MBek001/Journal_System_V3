<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>{{ page_title }}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Quill Editor CSS -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">

    <style>
        /* Custom loading animation */
        .loading-spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        /* Custom select styling */
        .author-select {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            background: white;
        }

        .author-option {
            padding: 12px 16px;
            border-bottom: 1px solid #f3f4f6;
            cursor: pointer;
            transition: all 0.2s;
        }

        .author-option:hover {
            background-color: #f8fafc;
        }

        .author-option:last-child {
            border-bottom: none;
        }

        .author-option.selected {
            background-color: #dbeafe;
            border-left: 4px solid #3b82f6;
        }

        /* Progress bar */
        .progress-bar {
            width: 0%;
            height: 4px;
            background: linear-gradient(90deg, #3b82f6, #1d4ed8);
            border-radius: 2px;
            transition: width 0.3s ease;
        }

        /* Quill Editor Customization */
        .ql-editor {
            min-height: 200px;
            font-size: 14px;
            line-height: 1.6;
        }

        .ql-toolbar {
            border-top: 1px solid #d1d5db;
            border-left: 1px solid #d1d5db;
            border-right: 1px solid #d1d5db;
            border-radius: 8px 8px 0 0;
            background: #f9fafb;
        }

        .ql-container {
            border-bottom: 1px solid #d1d5db;
            border-left: 1px solid #d1d5db;
            border-right: 1px solid #d1d5db;
            border-radius: 0 0 8px 8px;
            font-family: inherit;
        }

        .ql-editor.ql-blank::before {
            color: #9ca3af;
            font-style: normal;
        }

        /* Hide the original textarea */
        #id_message {
            display: none;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 text-gray-900 min-h-screen">
<main class="mx-auto max-w-4xl p-4 sm:p-6 lg:p-8">
    <!-- Header Section -->
    <div class="text-center mb-8">
        <div class="inline-flex items-center justify-center w-16 h-16 bg-blue-100 rounded-full mb-4">
            <i class="fas fa-envelope text-2xl text-blue-600"></i>
        </div>
        <h1 class="text-3xl sm:text-4xl font-bold text-gray-800 mb-2">{{ page_title }}</h1>
        <p class="text-gray-600 max-w-2xl mx-auto">Send personalized messages to your authors with ease. Select
            individual authors or broadcast to everyone.</p>
    </div>

    <section class="bg-white rounded-2xl shadow-xl ring-1 ring-gray-200 overflow-hidden">
        <!-- Progress Bar -->
        <div class="h-1 bg-gray-200">
            <div id="progress-bar" class="progress-bar"></div>
        </div>

        <!-- Back Button -->
        <div class="fixed top-6 left-6 z-50">
            <a href="{% url 'custom_admin' %}"
               class="inline-flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-full shadow-lg transition-all duration-200 hover:scale-105">
                <i class="fas fa-arrow-left"></i>
                <span class="hidden sm:inline">Back to Dashboard</span>
            </a>
        </div>

        <div class="p-6 sm:p-8">
            <!-- Messages -->
            {% if messages %}
                <div class="space-y-3 mb-8">
                    {% for message in messages %}
                        <div class="flex items-start gap-3 p-4 rounded-lg
                {% if message.tags == 'success' %} bg-green-50 border border-green-200
                {% elif message.tags == 'error' %} bg-red-50 border border-red-200
                {% elif message.tags == 'warning' %} bg-yellow-50 border border-yellow-200
                {% else %} bg-blue-50 border border-blue-200 {% endif %}">
                            <div class="flex-shrink-0 mt-0.5">
                                {% if message.tags == 'success' %}
                                    <i class="fas fa-check-circle text-green-600"></i>
                                {% elif message.tags == 'error' %}
                                    <i class="fas fa-exclamation-circle text-red-600"></i>
                                {% elif message.tags == 'warning' %}
                                    <i class="fas fa-exclamation-triangle text-yellow-600"></i>
                                {% else %}
                                    <i class="fas fa-info-circle text-blue-600"></i>
                                {% endif %}
                            </div>
                            <div class="text-sm font-medium
                  {% if message.tags == 'success' %} text-green-800
                  {% elif message.tags == 'error' %} text-red-800
                  {% elif message.tags == 'warning' %} text-yellow-800
                  {% else %} text-blue-800 {% endif %}">
                                {{ message }}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}

            <form method="post" id="email-form" class="space-y-8">
                {% csrf_token %}

                {% if form.non_field_errors %}
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                        <div class="flex items-start gap-3">
                            <i class="fas fa-exclamation-circle text-red-600 mt-0.5"></i>
                            <div class="text-sm text-red-800">
                                {% for error in form.non_field_errors %}
                                    <p>{{ error }}</p>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                {% endif %}

                <!-- Send to All Section -->
                <div class="bg-gray-50 rounded-xl p-6">
                    <div class="flex items-start gap-4">
                        <div class="flex-shrink-0 mt-1">
                            {{ form.send_to_all }}
                        </div>
                        <div class="flex-1">
                            <label for="{{ form.send_to_all.id_for_label }}"
                                   class="block text-lg font-semibold text-gray-800 mb-2">
                                <i class="fas fa-broadcast-tower text-blue-600 mr-2"></i>
                                {{ form.send_to_all.label }}
                            </label>
                            <p class="text-sm text-gray-600">{{ form.send_to_all.help_text }}</p>
                            <div id="total-authors" class="mt-2 text-sm font-medium text-blue-600">
                                <i class="fas fa-users mr-1"></i>
                                Total Active Authors: <span id="author-count">{{ authors.count }}</span>
                            </div>
                        </div>
                    </div>
                    {% if form.send_to_all.errors %}
                        <ul class="mt-3 text-sm text-red-600 list-disc pl-5">
                            {% for error in form.send_to_all.errors %}
                                <li>{{ error }}</li>
                            {% endfor %}
                        </ul>
                    {% endif %}
                </div>

                <!-- Authors Selection -->
                <div>
                    <div class="flex items-center justify-between mb-4">
                        <label for="{{ form.authors.id_for_label }}" class="block text-lg font-semibold text-gray-800">
                            <i class="fas fa-user-friends text-blue-600 mr-2"></i>
                            {{ form.authors.label }}
                        </label>
                        <div class="flex items-center gap-3">
                <span id="selected-count" class="text-sm font-medium text-gray-600">
                  Selected: <span class="text-blue-600">0</span>
                </span>
                            <div class="flex items-center gap-2">
                                <input type="checkbox" id="select-all-authors"
                                       class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                <label for="select-all-authors" class="text-sm font-medium text-gray-700">Select
                                    All</label>
                            </div>
                        </div>
                    </div>

                    <!-- Custom Author List -->
                    <div class="author-select" id="author-list">
                        {% for author in authors %}
                            <div class="author-option" data-author-id="{{ author.id }}">
                                <div class="flex items-center gap-3">
                                    <input type="checkbox" name="authors" value="{{ author.id }}"
                                           id="author_{{ author.id }}"
                                           class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                    <div class="flex-1">
                                        <div class="flex items-center gap-2">
                        <span class="inline-flex items-center justify-center w-6 h-6 bg-blue-100 text-blue-800 text-xs font-bold rounded-full">
                          {{ forloop.counter }}
                        </span>
                                            <label for="author_{{ author.id }}"
                                                   class="font-medium text-gray-900 cursor-pointer">
                                                {{ author.full_name }}
                                            </label>
                                            {% if author.position %}
                                                <span class="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded-full">
                            {{ author.position }}
                          </span>
                                            {% endif %}
                                        </div>
                                        <div class="mt-1 text-sm text-gray-600">
                                            <i class="fas fa-envelope mr-1"></i>
                                            {{ author.email }}
                                            {% if author.affiliation %}
                                                <span class="ml-3">
                            <i class="fas fa-university mr-1"></i>
                            {{ author.affiliation }}
                          </span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% empty %}
                            <div class="text-center py-8 text-gray-500">
                                <i class="fas fa-user-slash text-3xl mb-2"></i>
                                <p>No active authors found.</p>
                            </div>
                        {% endfor %}
                    </div>

                    {% if form.authors.help_text %}
                        <p class="mt-3 text-sm text-gray-500">{{ form.authors.help_text }}</p>
                    {% endif %}
                    {% if form.authors.errors %}
                        <ul class="mt-3 text-sm text-red-600 list-disc pl-5">
                            {% for error in form.authors.errors %}
                                <li>{{ error }}</li>
                            {% endfor %}
                        </ul>
                    {% endif %}
                </div>

                <!-- Subject -->
                <div>
                    <label for="{{ form.subject.id_for_label }}" class="block text-lg font-semibold text-gray-800 mb-3">
                        <i class="fas fa-tag text-blue-600 mr-2"></i>
                        {{ form.subject.label }}
                    </label>
                    {{ form.subject }}
                    {% if form.subject.help_text %}
                        <p class="mt-2 text-sm text-gray-500">{{ form.subject.help_text }}</p>
                    {% endif %}
                    {% if form.subject.errors %}
                        <ul class="mt-2 text-sm text-red-600 list-disc pl-5">
                            {% for error in form.subject.errors %}
                                <li>{{ error }}</li>
                            {% endfor %}
                        </ul>
                    {% endif %}
                </div>

                <!-- Message with Quill Editor -->
                <div>
                    <label for="{{ form.message.id_for_label }}" class="block text-lg font-semibold text-gray-800 mb-3">
                        <i class="fas fa-edit text-blue-600 mr-2"></i>
                        {{ form.message.label }}
                    </label>

                    <!-- Hidden textarea (Django form field) -->
                    {{ form.message }}

                    <!-- Quill Editor Container -->
                    <div id="quill-editor" data-placeholder="Write your message here..."></div>

                    <div class="mt-2 flex justify-between items-center">
                        {% if form.message.help_text %}
                            <p class="text-sm text-gray-500">{{ form.message.help_text }}</p>
                        {% endif %}
                        <div class="flex items-center gap-4">
                            <span id="word-count" class="text-sm text-gray-400">0 words</span>
                            <span id="char-count" class="text-sm text-gray-400">0 characters</span>
                        </div>
                    </div>
                    {% if form.message.errors %}
                        <ul class="mt-2 text-sm text-red-600 list-disc pl-5">
                            {% for error in form.message.errors %}
                                <li>{{ error }}</li>
                            {% endfor %}
                        </ul>
                    {% endif %}
                </div>

                <!-- Submit Button -->
                <div class="pt-6 border-t border-gray-200">
                    <button type="submit" id="submit-btn"
                            class="w-full inline-flex justify-center items-center gap-3 rounded-xl bg-gradient-to-r from-blue-600 to-blue-700 px-6 py-4 text-white font-semibold shadow-lg hover:from-blue-700 hover:to-blue-800 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transform transition-all duration-200 hover:scale-[1.02] disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none">
              <span id="btn-text">
                <i class="fas fa-paper-plane mr-2"></i>
                Send Message
              </span>
                        <div id="btn-loading" class="hidden">
                            <div class="loading-spinner"></div>
                            <span class="ml-2">Sending...</span>
                        </div>
                    </button>

                    <!-- Send Summary -->
                    <div id="send-summary" class="hidden mt-4 p-4 bg-blue-50 rounded-lg border border-blue-200">
                        <div class="flex items-center gap-2 text-blue-800">
                            <i class="fas fa-info-circle"></i>
                            <span class="font-medium">Ready to send:</span>
                            <span id="summary-text"></span>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </section>
</main>

<!-- Quill Editor JavaScript -->
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const selectAllCheckbox = document.getElementById('select-all-authors');
        const authorCheckboxes = document.querySelectorAll('input[name="authors"]');
        const sendToAllCheckbox = document.getElementById('id_send_to_all');
        const authorList = document.getElementById('author-list');
        const selectedCount = document.getElementById('selected-count');
        const submitBtn = document.getElementById('submit-btn');
        const btnText = document.getElementById('btn-text');
        const btnLoading = document.getElementById('btn-loading');
        const sendSummary = document.getElementById('send-summary');
        const summaryText = document.getElementById('summary-text');
        const progressBar = document.getElementById('progress-bar');
        const messageTextarea = document.getElementById('id_message');
        const charCount = document.getElementById('char-count');
        const wordCount = document.getElementById('word-count');

        // Pre-select author if author_id is provided
        {% if author_id %}
            const targetAuthorId = {{ author_id }};
            const targetCheckbox = document.querySelector(`input[name="authors"][value="${targetAuthorId}"]`);
            if (targetCheckbox) {
                targetCheckbox.checked = true;
                // Scroll to the selected author
                const authorOption = targetCheckbox.closest('.author-option');
                if (authorOption) {
                    authorOption.scrollIntoView({behavior: 'smooth', block: 'center'});
                    authorOption.style.backgroundColor = '#fff3cd'; // Highlight the selected author
                    setTimeout(() => {
                        authorOption.style.backgroundColor = '';
                    }, 3000);
                }
            }
        {% endif %}

        // Initialize Quill Editor
        const quill = new Quill('#quill-editor', {
            theme: 'snow',
            placeholder: 'Write your message here...',
            modules: {
                toolbar: [
                    [{'header': [1, 2, 3, false]}],
                    ['bold', 'italic', 'underline', 'strike'],
                    [{'color': []}, {'background': []}],
                    [{'list': 'ordered'}, {'list': 'bullet'}],
                    [{'align': []}],
                    ['link', 'blockquote', 'code-block'],
                    ['clean']
                ]
            }
        });

        // Sync Quill content with Django textarea
        quill.on('text-change', function () {
            const html = quill.root.innerHTML;
            const text = quill.getText();

            messageTextarea.value = html;

            const charLength = text.trim().length;
            const wordLength = text.trim() ? text.trim().split(/\s+/).length : 0;

            charCount.textContent = charLength + ' characters';
            wordCount.textContent = wordLength + ' words';
        });

        // Load existing content into Quill
        if (messageTextarea.value) {
            quill.root.innerHTML = messageTextarea.value;
        }

        // Update selected count
        function updateSelectedCount() {
            const selected = document.querySelectorAll('input[name="authors"]:checked').length;
            selectedCount.innerHTML = `Selected: <span class="text-blue-600">${selected}</span>`;

            authorCheckboxes.forEach(checkbox => {
                const option = checkbox.closest('.author-option');
                if (checkbox.checked) {
                    option.classList.add('selected');
                } else {
                    option.classList.remove('selected');
                }
            });

            updateSendSummary();
        }

        // Update send summary
        function updateSendSummary() {
            const sendToAll = sendToAllCheckbox.checked;
            const selectedAuthors = document.querySelectorAll('input[name="authors"]:checked').length;
            const totalAuthors = {{ authors.count }};

            if (sendToAll) {
                summaryText.textContent = `${totalAuthors} authors (all active authors)`;
                sendSummary.classList.remove('hidden');
            } else if (selectedAuthors > 0) {
                summaryText.textContent = `${selectedAuthors} selected authors`;
                sendSummary.classList.remove('hidden');
            } else {
                sendSummary.classList.add('hidden');
            }
        }

        // Select all functionality
        if (selectAllCheckbox) {
            selectAllCheckbox.addEventListener('change', function () {
                authorCheckboxes.forEach(checkbox => {
                    checkbox.checked = this.checked;
                });
                updateSelectedCount();
            });
        }

        // Individual checkbox changes
        authorCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function () {
                updateSelectedCount();

                const allChecked = Array.from(authorCheckboxes).every(cb => cb.checked);
                const noneChecked = Array.from(authorCheckboxes).every(cb => !cb.checked);

                if (allChecked) {
                    selectAllCheckbox.checked = true;
                    selectAllCheckbox.indeterminate = false;
                } else if (noneChecked) {
                    selectAllCheckbox.checked = false;
                    selectAllCheckbox.indeterminate = false;
                } else {
                    selectAllCheckbox.checked = false;
                    selectAllCheckbox.indeterminate = true;
                }
            });
        });

        // Send to all toggle
        if (sendToAllCheckbox) {
            const toggleAuthorsSelect = () => {
                const disabled = sendToAllCheckbox.checked;
                authorList.style.opacity = disabled ? '0.5' : '1';
                authorList.style.pointerEvents = disabled ? 'none' : 'auto';
                selectAllCheckbox.disabled = disabled;

                if (disabled) {
                    authorCheckboxes.forEach(checkbox => {
                        checkbox.checked = false;
                    });
                    selectAllCheckbox.checked = false;
                    selectAllCheckbox.indeterminate = false;
                }

                updateSelectedCount();
            };

            sendToAllCheckbox.addEventListener('change', toggleAuthorsSelect);
            toggleAuthorsSelect();
        }

        // Form submission with loading state
        document.getElementById('email-form').addEventListener('submit', function (e) {
            const html = quill.root.innerHTML;
            messageTextarea.value = html;

            submitBtn.disabled = true;
            btnText.classList.add('hidden');
            btnLoading.classList.remove('hidden');

            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += Math.random() * 15;
                if (progress > 90) progress = 90;
                progressBar.style.width = progress + '%';
            }, 200);

            window.addEventListener('beforeunload', () => {
                clearInterval(progressInterval);
            });
        });

        // Initial setup
        updateSelectedCount();
    });
</script>
</body>
</html>